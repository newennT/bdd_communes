{% extends 'base.html.twig' %}

{% block title %}Commune index{% endblock %}

{% block body %}
    <div class="mt-4">
        <h1>Liste des communes</h1>
    </div>
    

    <div id="map-index-commune" class="container img-fluid rounded-top mt-4"></div>

    <div class="home-section02 container">
        <form class="row g-3" id="filter-form" method="get">
            
            <div class="col-12 col-md-4">
                <select class="form-control" name="pays" id="pays">
                    <option value="">-- Choisir un pays --</option>
                    {% for item in pays %}
                        <option value="{{ item.id }}" {% if currentFilters.pays == item.id %}selected{% endif %}>{{ item.nomFrancais }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-12 col-md-4">
                <select class="form-control" name="eveche" id="eveche">
                    <option value="">-- Choisir un évêché --</option>
                    {% for eveche in eveches %}
                        <option value="{{ eveche.id }}" {% if currentFilters.eveche == eveche.id %}selected{% endif %}>{{ eveche.nomFrancais }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-6 col-md-2">
                <button class="btn btn-secondary w-100" type="submit">Filtrer</button>
            </div>
            
            <div class="col-6 col-md-2">
                <button type="button" class="btn btn-outline-light w-100"><a class="nav-link text-light" href="{{ path('app_commune_index') }}">Réinitialiser</a></button>
            </div>
            
        </form>
    </div>



    <div class="index-communes-section02 container my-5">
        {% if is_granted('IS_AUTHENTICATED') %}
            <a class="btn btn-warning" href="{{ path('app_admin_commune_new') }}">Create new</a>
        {% endif %}
        {# Liste #}
            <table class="table table-striped table-hover align-middle table-responsive">
            <thead class="thead-table">
                <tr>
                    <th></th>
                    <th>Nom</th>
                    <th>Evêché</th>
                    <th>Pays</th>
                </tr>
            </thead>

            <tbody>
            {% for commune in communesPagination %}
                    <tr>
                        <td class="fw-lighter"><small>{{ commune.code }}</small></td>
                        <td>
                            <a href="{{ path('app_commune_show', {'id': commune.id, '_locale': app.request.locale}) }}">
                            {{ commune.getNomParLangue(app.request.locale) }}
                            </a>
                        </td>
                        <td>
                            <a href="{{ path('app_eveche_show', {'id': commune.idEveche.id, '_locale': app.request.locale}) }}">
                            {{ commune.idEveche.getNomParLangue(app.request.locale) }}
                            </a>
                        </td>
                        <td>
                            <a href="{{ path('app_eveche_show', {'id': commune.idEveche.id, '_locale': app.request.locale}) }}">
                            {{ commune.idPays.getNomParLangue(app.request.locale) }}
                            </a>
                        </td>

                        {% if is_granted('IS_AUTHENTICATED') %}
                        <td><a class="btn btn-warning" href="{{ path('app_admin_commune_edit', {'id': commune.id}) }}">Modifier</a></td>
                        {% endif %}
                    </tr>

            {% else %}
                Aucune commune à afficher
            {% endfor %}
            </tbody>
                
            </table>

            {# Navigation #}
                {% include 'partials/navigation.html.twig' %}

    </div>



{% endblock %}

{% block javascripts %}
{{ parent() }}

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>

    document.addEventListener('DOMContentLoaded', function () {
        let nbHabitants;
        let color;
        let radius;

        function getColorByPopulation(nbHabitants) {
            return '#ff0000';
        }

        function getRadius(nbHabitants){
            if (nbHabitants <= 1000) {
                return 2;
            } else if (nbHabitants <= 2500){
                return 4;
            } else if (nbHabitants <= 5000){
                return 8;
            } else if (nbHabitants <= 10000){
                return 12;
            } else if (nbHabitants <= 50000){
                return 18;
            } else if (nbHabitants <= 100000){
                return 25;
            } else {
                return 35;
            }
        }

        var map = L.map('map-index-commune').setView([48, -2.7 ], 8);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);


        {% for commune in communes %}

        nbHabitants = {{ commune.habitants }} ;
        color = getColorByPopulation(nbHabitants);
        radius = getRadius(nbHabitants);

        L.circle([{{ commune.latitude }}, {{ commune.longitude }}], {
                        color: '#000000',
                        weight: 1,
                        fillColor: color,
                        radius: radius*220,
                        fillOpacity: 0.5
                    })
            .addTo(map)
            .bindPopup('<strong>{{ commune.nomFrancais|escape("html") }}</strong>') 
            .on('click', function () {
                circle.openPopup();  
            });
       

        {% endfor %}
     });
</script>

{% endblock %}